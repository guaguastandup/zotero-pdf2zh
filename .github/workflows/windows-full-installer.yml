name: Build Windows Full Installer

on:
  workflow_dispatch:
    inputs:
      server_version:
        description: "Version label used in installer filename (e.g. 3.0.38)"
        required: true
        default: "3.0.38-dev"
        type: string
      engine_sha256:
        description: "SHA256 override (leave empty to use bundle-manifest.json)"
        required: false
        default: ""
        type: string

jobs:
  build-installer:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup --no-progress -y

      - name: Resolve engine SHA256
        id: sha
        shell: pwsh
        run: |
          $inputSha = "${{ inputs.engine_sha256 }}".Trim()
          if ($inputSha -ne "") {
            "value=$inputSha" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            $manifest = Get-Content "server/packaging/windows/bundle-manifest.json" -Raw | ConvertFrom-Json
            $sha = $manifest.engine.sha256
            if ([string]::IsNullOrWhiteSpace($sha)) {
              throw "No SHA256 found in bundle-manifest.json and no override provided."
            }
            Write-Host "Using SHA256 from bundle-manifest.json: $sha"
            "value=$sha" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: Build full installer
        shell: pwsh
        run: |
          ./server/packaging/windows/build-full-installer.ps1 `
            -Version "${{ inputs.server_version }}" `
            -EngineSha256 "${{ steps.sha.outputs.value }}" `
            -Clean

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-full-installer-${{ inputs.server_version }}
          path: build/windows/installer-output/*.exe
          if-no-files-found: error
