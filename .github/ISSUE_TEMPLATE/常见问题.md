# Zotero PDF2zh - 常见问题与排查指南

本指南旨在帮助您解决在使用 Zotero PDF2zh 插件时可能遇到的常见问题。

## ⚠️ 提问前必读

**不要在置顶 Issue 下提问** - 请为每个新问题单独开一个 Issue。

在提交问题之前，请务必遵循以下步骤：

1. **更新至最新版本**：确保插件已更新到 **v3.0.x** 版本（旧版v2.4.3已停止维护）
2. **查阅文档**：
   - 阅读 [README 安装指南](https://github.com/guaguastandup/zotero-pdf2zh)
   - 阅读 [常见问题文档](https://docs.qq.com/markdown/DU0RPQU1vaEV6UXJC) by [@Rosetears520](https://github.com/Rosetears520)
3. **搜索现有 Issue**：在 [Issue 区](https://github.com/guaguastandup/zotero-pdf2zh/issues) 搜索，**包括已关闭的 Issue**
4. **基础问题向 AI 提问**：虚拟环境、Python/conda安装、权限问题等基础问题请优先使用 AI 工具
5. **提供完整信息**：提问时需提供终端报错、Zotero设置截图、插件配置截图

---

## 🔥 高频问题

### 1. 网络连接问题

**错误信息**: `NetworkError when attempting to fetch resource`

**排查步骤**:
- [ ] 确保插件是 **v3.0.x** 版本（而非旧版v2.4.3）
- [ ] 确保 `server.py` 脚本正在运行
- [ ] 检查 8890 端口是否被占用
- [ ] 尝试切换端口（需同时修改两处：插件配置和 `server.py --port=新端口`）
- [ ] 检查防火墙设置
- [ ] 关闭杀毒软件并重启电脑
- [ ] 如果终端有日志输出但报网络错误，优先解决终端中的具体报错

### 2. DLL 初始化例程失败

**错误信息**: `"动态链接库(DLL)初始化例程失败"`

**解决方案**:
1. 进入虚拟环境，将 `onnx` 包降级到 `1.16.1` 版本
   - pdf2zh 对应虚拟环境：`zotero-pdf2zh-venv`
   - pdf2zh_next 对应虚拟环境：`zotero-pdf2zh-next-venv`
2. 安装 [vs_redist.x86.exe](https://aka.ms/vs/17/release/vc_redist.x86.exe)（而非x64版本）
3. macOS旧版本用户需使用 Python 3.11 而非 3.12

### 3. Failed to canonicalize script path

**解决方案**: 删除 `server` 路径下的 `zotero-pdf2zh-next-venv` 或 `zotero-pdf2zh-venv` 文件夹，然后重新配置。

**注意**: 使用 uv 方法安装后，不可以修改路径名/移动文件夹。

### 4. 翻译卡住/进度条不动

**原因**: pdf2zh_next 首次启动需要下载字体和模型文件

**解决方案**:
1. 访问 [pdf2zh_next releases](https://github.com/PDFMathTranslate-next/PDFMathTranslate-next/releases)
2. 下载 exe 包（如 `pdf2zh-v2.6.4-BabelDOC-xxx-with-assets-win64.zip`）
3. 解压后运行 `pdf2zh.exe`，打开 `http://127.0.0.1:7860/`，翻译一篇文章后退出
4. 回到插件重新翻译

### 5. Scanned PDF detected

**说明**:
- pdf2zh 和 pdf2zh_next **不直接提供 OCR 功能**
- 需要先用其他工具对扫描版文件进行 OCR 处理
- OCR 选项只是对 OCR 后文件的兼容方案，保持开启即可

### 6. Bing/Google 翻译报错/卡住

**原因**: Bing/Google 限流严重

**解决方案**:
- 将线程数设置得非常低（建议2及以下）
- 建议更换为更稳定的服务（如 deepseek、silicon 等）

---

## 虚拟环境问题

### Q: 不想使用虚拟环境怎么办？

如果您只使用 pdf2zh_next/pdf2zh 引擎中的一个，且 Python 版本为 3.12.0，可以不使用虚拟环境：

```shell
# 安装依赖
pip install -r requirements.txt

# 只使用 pdf2zh
pip install pdf2zh==1.9.11 numpy==2.2.0

# 只使用 pdf2zh_next
pip install pdf2zh_next
# 或
uv tool install --python 3.12 pdf2zh-next

# 运行脚本
python server.py --enable_venv=False
```

---

## 远程服务问题

### Q: 没配置 API 可以用吗？

只有以下**免费服务**无需配置 API：
- `siliconflowfree` - 仅支持 pdf2zh_next 引擎
- `bing` / `google` - 存在限流

其他服务均需配置 API Key 和 URL。

### Q: Token 消耗太大怎么办？

- 通常 10 页英文文献消耗约 7~10w token，单页约 5k
- 使用 pdf2zh_next 引擎时，可关闭"提取术语表"选项以减少消耗

---

## 提问规范

### 排查问题的原则

1. 认真阅读指南，几乎所有问题都有解决方案
2. 尝试阅读终端错误提示，在文档中搜索关键词
3. 提问时需提供：
   - 终端（命令行/cmd）的完整内容
   - Zotero 设置截图
   - Zotero 弹窗截图
   - 说明已查阅的文档和已尝试的解决方法

### 为什么没人回复？

- 问题显然是常见问题，需说明已查阅常见问题但无法解决
- 漏看了，可以过一会重新发或 @群主
- 没有发送终端信息，无法排查问题

---

## 其他支持方式

- **QQ群**:
  - 5群: 1064435415
  - 6群: 1083772600
  - 入群问题答案: github
- **视频教程**:
  - [@她笑中藏泪花](https://www.bilibili.com/video/BV1FnHYzeEfj/)
  - [@尛希](https://www.bilibili.com/video/BV1hraMzuEP8/)
- **Docker部署**:
  - [方法一](../../docker/README.md) by [@Rosetears520](https://github.com/Rosetears520)
  - [方法二](../../docker2/README.md) by [@taozhe6](https://github.com/taozhe6)
- **Homebrew部署**: [NightWatcher314/zotero-pdf2zh-server](https://github.com/NightWatcher314/zotero-pdf2zh-server)

---

## 翻译服务参考

| 服务类型 | 服务名称 | 注意事项 |
|---------|---------|---------|
| 免费 | siliconflowfree | 仅支持 pdf2zh_next，可能漏翻译 |
| 免费 | bing/google | 限流严重，建议并发≤2 |
| 优惠 | openaliked | 火山引擎协作计划，每日50w token赠送，并发可设500-1000 |
| 优惠 | silicon | 邀请好友获14元赠送，免费版线程建议≤6 |
| 优惠 | zhipu | 部分模型免费，并发建议≤6 |
| 高质量 | deepseek | 推荐，有缓存命中机制 |
| 高质量 | aliyunDashScope | 翻译效果好，新用户有赠送 |
